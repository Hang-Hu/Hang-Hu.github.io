<h2 id="details">Details</h2>

<p>I have both <code class="highlighter-rouge">inMemoryAuthentication()</code> and <code class="highlighter-rouge">userDetailsService()</code> for method <code class="highlighter-rouge">configureGlobalSecurity</code>. <code class="highlighter-rouge">inMemoryAuthentication()</code> works well both in getting access token, refresh token and accessing with access token. <code class="highlighter-rouge">userDetailsService()</code> works in the term of getting token and get <code class="highlighter-rouge">access_denied</code> when accessing resources.</p>
<h2 id="reason">Reason</h2>

<p>By default role should begin with prefix <code class="highlighter-rouge">ROLE_</code>.</p>
<h2 id="solution">Solution</h2>

<ol>
  <li>Change <code class="highlighter-rouge">.antMatchers("/user/**").access("hasRole('USER')")</code> to <code class="highlighter-rouge">.antMatchers("/user/**").access("hasRole('ROLE_USER')")</code> in <code class="highlighter-rouge">configure(HttpSecurity http)</code>.</li>
  <li>Add ‘ROLE_’ to ‘USER’, ‘ADMIN’ in database.
    <h2 id="further">Further</h2>
  </li>
</ol>

<p>If you don’t want to use <code class="highlighter-rouge">ROLE_</code> as prefix, change it in <code class="highlighter-rouge">spring-security.xml</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;!-- Configuring RoleVoter bean to use custom access roles, by default roles 
		should be in the form ROLE_{XXX} --&gt;
	&lt;beans:bean id="roleVoter"
		class="org.springframework.security.access.vote.RoleVoter"&gt;
		&lt;beans:property name="rolePrefix" value=""&gt;&lt;/beans:property&gt;
	&lt;/beans:bean&gt;
	&lt;beans:bean id="accessDecisionManager"
		class="org.springframework.security.access.vote.AffirmativeBased"&gt;
		&lt;beans:constructor-arg name="decisionVoters"
			ref="roleVoter" /&gt;
	&lt;/beans:bean&gt;
</code></pre>
</div>
