<h2 id="background">Background</h2>

<p>I had built an easy REST application using annotation and <code class="highlighter-rouge">OAuth2</code> to protect the rest api. However, the project I actually want to use <code class="highlighter-rouge">OAuth2</code> is based on <code class="highlighter-rouge">xml</code>. Then I had to convert annotation to <code class="highlighter-rouge">xml</code>. When I finally finished the work, I get a response <code class="highlighter-rouge"><span class="p">{</span><span class="nt">"error"</span><span class="p">:</span><span class="s2">"invalid_grant"</span><span class="p">,</span><span class="nt">"error_description"</span><span class="p">:</span><span class="s2">"Bad credentials"</span><span class="p">}</span></code> requested by postman. It likely to be a prolem caused by my <code class="highlighter-rouge">xml</code> config, because I didn’t change anything but the annotation and Java config and my username, password, clientId, secret all works well in the annotation version. Unfortunately, I don’t find any material useful to my case on the Internet, so I have to debug it to the the precise reason.</p>
<h2 id="config-related-to-security">Config related to security</h2>

<blockquote>
  <p>security.xml</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans:beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/security"</span>
       <span class="na">xmlns:beans=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:oauth=</span><span class="s">"http://www.springframework.org/schema/security/oauth2"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans</span>
                           <span class="err">http://www.springframework.org/schema/beans/spring-beans.xsd</span>
                           <span class="err">http://www.springframework.org/schema/security</span>
                           <span class="err">http://www.springframework.org/schema/security/spring-security.xsd</span>
                           <span class="err">http://www.springframework.org/schema/security/oauth2</span>
                           <span class="err">http://www.springframework.org/schema/security/spring-security-oauth2.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;http</span> <span class="na">pattern=</span><span class="s">"/oauth/token"</span>
          <span class="na">create-session=</span><span class="s">"stateless"</span>
          <span class="na">authentication-manager-ref=</span><span class="s">"clientAuthenticationManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;intercept-url</span> <span class="na">pattern=</span><span class="s">"/oauth/token"</span> <span class="na">access=</span><span class="s">"isFullyAuthenticated()"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;anonymous</span> <span class="na">enabled=</span><span class="s">"false"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;csrf</span> <span class="na">disabled=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;access-denied-handler</span> <span class="na">ref=</span><span class="s">"accessDeniedHandler"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;http-basic</span> <span class="na">entry-point-ref=</span><span class="s">"authenticationEntryPoint"</span><span class="nt">&gt;&lt;/http-basic&gt;</span>
    <span class="nt">&lt;/http&gt;</span>
    <span class="nt">&lt;http</span> <span class="na">create-session=</span><span class="s">"never"</span> <span class="na">entry-point-ref=</span><span class="s">"authenticationEntryPoint"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;intercept-url</span> <span class="na">pattern=</span><span class="s">"/user/**"</span> <span class="na">access=</span><span class="s">"hasRole('ROLE_USER')"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;anonymous</span> <span class="na">enabled=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;access-denied-handler</span> <span class="na">ref=</span><span class="s">"accessDeniedHandler"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;custom-filter</span> <span class="na">ref=</span><span class="s">"resourceServerFilter"</span> <span class="na">before=</span><span class="s">"PRE_AUTH_FILTER"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/http&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"authenticationEntryPoint"</span>
                <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;beans:property</span> <span class="na">name=</span><span class="s">"realmName"</span> <span class="na">value=</span><span class="s">"HUHANG_OAUTH_REALM/client"</span><span class="nt">&gt;&lt;/beans:property&gt;</span>

    <span class="nt">&lt;/beans:bean&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"accessDeniedHandler"</span>
                <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>

    <span class="nt">&lt;authentication-manager</span> <span class="na">id=</span><span class="s">"userAuthenticationManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">"customUserDetailsService"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/authentication-manager&gt;</span>
    <span class="nt">&lt;authentication-manager</span> <span class="na">id=</span><span class="s">"clientAuthenticationManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;authentication-provider</span> <span class="na">user-service-ref=</span><span class="s">"clientDetailsUserDetailsService"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/authentication-manager&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"clientDetailsUserDetailsService"</span>
            <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;beans:constructor-arg</span> <span class="na">ref=</span><span class="s">"customClientDetailsService"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"inMemoryTokenStore"</span>
                <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"tokenStoreUserApprovalHandler"</span>
            <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.approval.TokenStoreUserApprovalHandler"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;beans:property</span> <span class="na">name=</span><span class="s">"tokenStore"</span> <span class="na">ref=</span><span class="s">"inMemoryTokenStore"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;beans:property</span> <span class="na">name=</span><span class="s">"requestFactory"</span> <span class="na">ref=</span><span class="s">"oAuth2RequestFactory"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;beans:property</span> <span class="na">name=</span><span class="s">"clientDetailsService"</span> <span class="na">ref=</span><span class="s">"customClientDetailsService"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"oAuth2RequestFactory"</span> 
            <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.request.DefaultOAuth2RequestFactory"</span><span class="nt">&gt;</span>

        <span class="nt">&lt;beans:constructor-arg</span> <span class="na">ref=</span><span class="s">"customClientDetailsService"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"tokenApprovalStore"</span>
            <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.approval.TokenApprovalStore"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>


    <span class="nt">&lt;oauth:authorization-server</span> <span class="na">client-details-service-ref=</span><span class="s">"customClientDetailsService"</span>
                                <span class="na">token-services-ref=</span><span class="s">"tokenServices"</span>
                                <span class="na">user-approval-handler-ref=</span><span class="s">"tokenStoreUserApprovalHandler"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;oauth:authorization-code/&gt;</span>
        <span class="nt">&lt;oauth:implicit/&gt;</span>
        <span class="nt">&lt;oauth:refresh-token/&gt;</span>
        <span class="nt">&lt;oauth:client-credentials/&gt;</span>
        <span class="nt">&lt;oauth:password/&gt;</span>

    <span class="nt">&lt;/oauth:authorization-server&gt;</span>
    <span class="nt">&lt;oauth:resource-server</span> <span class="na">id=</span><span class="s">"resourceServerFilter"</span>
                           <span class="na">resource-id=</span><span class="s">"huhang_rest_api"</span>
                           <span class="na">stateless=</span><span class="s">"false"</span>
                            <span class="na">token-services-ref=</span><span class="s">"tokenServices"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;global-method-security</span> <span class="na">pre-post-annotations=</span><span class="s">"enabled"</span> <span class="na">proxy-target-class=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;expression-handler</span> <span class="na">ref=</span><span class="s">"oAuth2MethodSecurityExpressionHandler"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/global-method-security&gt;</span>
    <span class="nt">&lt;oauth:expression-handler</span> <span class="na">id=</span><span class="s">"oAuth2MethodSecurityExpressionHandler"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;beans:bean</span> <span class="na">id=</span><span class="s">"tokenServices"</span>
            <span class="na">class=</span><span class="s">"org.springframework.security.oauth2.provider.token.DefaultTokenServices"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;beans:property</span> <span class="na">name=</span><span class="s">"tokenStore"</span> <span class="na">ref=</span><span class="s">"inMemoryTokenStore"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;beans:property</span> <span class="na">name=</span><span class="s">"supportRefreshToken"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;beans:property</span> <span class="na">name=</span><span class="s">"clientDetailsService"</span> <span class="na">ref=</span><span class="s">"customClientDetailsService"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/beans:bean&gt;</span>
<span class="nt">&lt;/beans:beans&gt;</span>
</code></pre>
</div>

<blockquote>
  <p>class CustomClientDetailsService</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>@Service
public class CustomClientDetailsService implements ClientDetailsService{
    private String clientId="my_trusted_client";
    private String clientSecret="secret";
    @Override
    public ClientDetails loadClientByClientId(String clientId) throws ClientRegistrationException {
        if(clientId.equals(this.clientId)){
            List&lt;String&gt; authorizedGrantTypes=new LinkedList&lt;&gt;();
            authorizedGrantTypes.add("password");
            authorizedGrantTypes.add("authorization_code");
            authorizedGrantTypes.add("refresh_token");
            authorizedGrantTypes.add("implicit");
            List&lt;GrantedAuthority&gt; authorities=new LinkedList&lt;&gt;();
            authorities.add(new SimpleGrantedAuthority("ROLE_CLIENT"));
            authorities.add(new SimpleGrantedAuthority("ROLE_TRUSTED_CLIENT"));
            List&lt;String&gt; scopes=new LinkedList&lt;&gt;();
            scopes.add("read");
            scopes.add("write");
            scopes.add("trust");
            BaseClientDetails baseClientDetails=new BaseClientDetails();
            baseClientDetails.setClientId(clientId);
            baseClientDetails.setClientSecret(this.clientSecret);
            baseClientDetails.setAuthorizedGrantTypes(authorizedGrantTypes);
            baseClientDetails.setAuthorities(authorities);
            baseClientDetails.setScope(scopes);
            baseClientDetails.setAccessTokenValiditySeconds(120);
            baseClientDetails.setRefreshTokenValiditySeconds(600);
            return baseClientDetails;
        }else{
            throw new NoSuchClientException("");
        }
    }
}
</code></pre>
</div>

<blockquote>
  <p>class CustomUserDetailsService</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>@Service
public class CustomUserDetailsService implements UserDetailsService{
    @Autowired
    private UserService userService;
    @Transactional(readOnly = true)
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        UserDto userDto = userService.findByName(username);
        Set&lt;GrantedAuthority&gt; grantedAuthorities=new HashSet&lt;&gt;();
        for(Iterator&lt;String&gt; i=userDto.getRoles().iterator(); i.hasNext(); ){
            grantedAuthorities.add(new SimpleGrantedAuthority(i.next()));
        }
        return new User(
                userDto.getName(),
                userDto.getPassword(),
                true, true, true, true,
                grantedAuthorities);
    }
}
</code></pre>
</div>

<h2 id="proccess-of-debug-source">Proccess of debug source</h2>

<ol>
  <li>
    <p>Check of client is first so I add breakpoint in <code class="highlighter-rouge">CustomClientDetailsService</code>’s <code class="highlighter-rouge">loadClientByClientId</code> and check the result of it, which is ok.</p>
  </li>
  <li>
    <p>Then I step over to reach the first exception which is <code class="highlighter-rouge">UsernameNotFoundException</code>, and I add breakpoint to the line causing it.</p>
  </li>
</ol>

<p>&lt;img src=”/home/joanna/Pictures/CodePic/Note/debug1.png” width=100%/&gt;</p>

<ol>
  <li>
    <p>I press F9 to resume program and request again using postman to go to the breakpoint I just added. Press F9 four times to skip the first breakpoint I have just checked and reach the new breakpoint.</p>
  </li>
  <li>
    <p>Then I step into it using F7 to figure out what’s wrong where I get a  exception called <code class="highlighter-rouge">UsernameNotFoundException</code> and add the third breakpoint there.</p>
  </li>
</ol>

<p>&lt;img src=”/home/joanna/Pictures/CodePic/Note/debug2.png” width=100%/&gt;</p>

<ol>
  <li>Repeat to reach the third breakpoint and step into it, there I find the true reason of all these exceptions. Here is a method called <code class="highlighter-rouge">loadUserByUsername</code> which should call <code class="highlighter-rouge">loadUserByUsername</code> in class <code class="highlighter-rouge">CustomUserDetailsService</code>, but it calls <code class="highlighter-rouge">loadClientByClientId</code> in class <code class="highlighter-rouge">CustomClientDetailsService</code>, making the check of user to fail.</li>
</ol>

<p>&lt;img src=”/home/joanna/Pictures/CodePic/Note/debug3.png” width=100%/&gt;</p>

<h2 id="look-into-securityxml">Look into security.xml</h2>

<p>Now the reason of exceptions is that I use <code class="highlighter-rouge">CustomClientDetailsService</code> in where <code class="highlighter-rouge">CustomUserDetailsService</code> should be used. It’s easy to find <code class="highlighter-rouge">&lt;oauth:password/&gt;</code> in <code class="highlighter-rouge">&lt;oauth:authorization-server&gt;&lt;/oauth:authorization-server&gt;</code> lacks <code class="highlighter-rouge">authentication-manager-ref</code> which should reference to <code class="highlighter-rouge">userAuthenticationManager</code> which uses <code class="highlighter-rouge">customUserDetailsService</code> as <code class="highlighter-rouge">authentication-provider</code>.</p>

<blockquote>
  <p>The revised part in security.xml</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;oauth:authorization-server client-details-service-ref="customClientDetailsService"
                            token-services-ref="tokenServices"
                            user-approval-handler-ref="tokenStoreUserApprovalHandler"&gt;
    &lt;oauth:authorization-code/&gt;
    &lt;oauth:implicit/&gt;
    &lt;oauth:refresh-token/&gt;
    &lt;oauth:client-credentials/&gt;
    &lt;oauth:password authentication-manager-ref="userAuthenticationManager"/&gt;
&lt;/oauth:authorization-server&gt;
</code></pre>
</div>

<p>Restart server and it works well!</p>
